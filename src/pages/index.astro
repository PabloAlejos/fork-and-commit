---
import Layout from '../layouts/Layout.astro';
import RecipeFilters from '../components/RecipeFilters.astro';
import RecipeCard from '../components/RecipeCard.astro';
import { getCollection } from 'astro:content';

const recipes = await getCollection('recipes');
---

<Layout>
	<!-- Header -->
	<header class="header">
		<div class="header-inner">
			<h1 class="site-title">Fork & Commit</h1>
			<div class="tagline"><span class="prompt">$</span> Where recipes are never half-baked.<span class="cursor">_</span></div>
		</div>
		<div class="header-border"></div>
	</header>

	<main class="container">
		<!-- Componente de búsqueda y filtros -->
		<RecipeFilters />

		<div class="recipes-grid">
			{recipes.map((recipe, i) => (
				<div class="card-wrapper" style={`--delay: ${i * 0.06}s`}>
					<RecipeCard
						title={recipe.data.title}
						slug={recipe.slug}
						category={recipe.data.category}
						totalTime={recipe.data.total_time}
						difficulty={recipe.data.difficulty}
						servings={recipe.data.servings}
						tags={recipe.data.tags}
					/>
				</div>
			))}
		</div>
	</main>

	<!-- Footer -->
	<footer class="site-footer">
		<span class="footer-cmd">git cook --with-love</span>
	</footer>
</Layout>

<style>
	/* Header */
	.header {
		background: var(--terminal);
		padding: 1.5rem 2rem 0;
		text-align: center;
		position: relative;
	}

	.header-inner {
		padding-bottom: 1.5rem;
	}

	.header-border {
		height: 3px;
		background: linear-gradient(90deg, var(--ember), var(--saffron));
	}

	.site-title {
		font-family: 'Space Grotesk', sans-serif;
		font-size: 2rem;
		color: var(--parchment);
		font-weight: 700;
		letter-spacing: -0.02em;
		margin-bottom: 0.35rem;
	}

	.tagline {
		font-family: 'JetBrains Mono', monospace;
		color: var(--saffron);
		font-size: 0.85rem;
		font-weight: 400;
	}

	.prompt {
		color: var(--coral);
		margin-right: 0.25rem;
	}

	.cursor {
		color: var(--ember);
		animation: blink 1s step-end infinite;
	}

	@keyframes blink {
		0%, 100% { opacity: 1; }
		50% { opacity: 0; }
	}

	/* Container */
	.container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 2rem 1rem;
	}

	/* Recipes grid - Mobile first */
	.recipes-grid {
		display: grid;
		grid-template-columns: 1fr;
		gap: 1.5rem;
	}

	/* Card staggered animation */
	.card-wrapper {
		animation: fadeInUp 0.4s ease both;
		animation-delay: var(--delay);
	}

	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(16px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	/* Footer */
	.site-footer {
		text-align: center;
		padding: 2rem 1rem;
		border-top: 1px solid var(--simmer);
	}

	.footer-cmd {
		font-family: 'JetBrains Mono', monospace;
		font-size: 0.8rem;
		color: var(--graphite);
		opacity: 0.7;
	}

	/* Tablet and up */
	@media (min-width: 640px) {
		.recipes-grid {
			grid-template-columns: repeat(2, 1fr);
		}
	}

	/* Desktop */
	@media (min-width: 1024px) {
		.recipes-grid {
			grid-template-columns: repeat(3, 1fr);
		}
	}

	/* Responsive */
	@media (max-width: 640px) {
		.header {
			padding: 1rem 1.5rem 0;
		}

		.site-title {
			font-size: 1.5rem;
		}

		.tagline {
			font-size: 0.75rem;
		}

		.container {
			padding: 1.5rem 0.75rem;
		}
	}
</style>

<script>
	// Manejar clics en tags de las tarjetas
	document.addEventListener('DOMContentLoaded', () => {
		// Delegación de eventos para los tags clickables
		document.addEventListener('click', (e) => {
			const target = e.target as HTMLElement;

			// Si clickaron en un tag clickable
			if (target.classList.contains('tag-clickable')) {
				e.preventDefault();
				e.stopPropagation();

				const tag = target.dataset.tag;
				if (!tag) return;

				// Disparar evento personalizado para que RecipeFilters lo capture
				const event = new CustomEvent('selectTag', { detail: { tag } });
				window.dispatchEvent(event);
			}

			// Si clickaron en un link de receta, dejarlo pasar
			if (target.closest('.recipe-card') && !target.classList.contains('tag-clickable')) {
				return;
			}
		});

		// Procesar parámetro ?tag= en la URL
		const urlParams = new URLSearchParams(window.location.search);
		const tagFromUrl = urlParams.get('tag');

		if (tagFromUrl) {
			const event = new CustomEvent('selectTag', { detail: { tag: tagFromUrl } });
			window.dispatchEvent(event);

			window.history.replaceState({}, '', window.location.pathname);
		}
	});
</script>
